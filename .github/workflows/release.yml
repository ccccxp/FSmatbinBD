name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ¼å¼çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0, v1.1.0ï¼‰
    branches:
      - main  # main åˆ†æ”¯æ¨é€æ—¶ä¹Ÿæ„å»ºï¼ˆä½†ä¸å‘å¸ƒï¼‰
  pull_request:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.1.2)'
        required: false
        default: ''
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        type: boolean
        default: false

env:
  APP_NAME: FSMatbinBD
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Get version and update version.json
      id: version
      shell: pwsh
      run: |
        # è¯»å–å½“å‰ version.json
        $versionJsonPath = "version.json"
        if (Test-Path $versionJsonPath) {
          $versionConfig = Get-Content -Path $versionJsonPath -Raw | ConvertFrom-Json
          $version = $versionConfig.version
        } else {
          $version = "dev"
        }
        
        # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬ï¼ˆå¦‚æœæ˜¯æ ‡ç­¾è§¦å‘ï¼‰ï¼Œä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
        }
        
        # æ‰‹åŠ¨è¾“å…¥ç‰ˆæœ¬å·ä¼˜å…ˆçº§æœ€é«˜
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
        }
        
        # è·å–å½“å‰æ—¥æœŸ
        $buildDate = Get-Date -Format "yyyy-MM-dd"
        
        # æ›´æ–° version.json
        $versionConfig = @{
          version = $version
          build_date = $buildDate
          app_name = "${{ env.APP_NAME }}"
          description = "FromSoftware Material Binary Database"
        }
        $versionConfig | ConvertTo-Json -Depth 10 | Set-Content -Path $versionJsonPath -Encoding UTF8
        
        Write-Host "âœ“ Version: $version"
        Write-Host "âœ“ Build Date: $buildDate"
        Write-Host "âœ“ Updated version.json"
        
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "BUILD_DATE=$buildDate" >> $env:GITHUB_OUTPUT
        
    - name: Build with PyInstaller
      run: |
        pyinstaller FSMatbinBD.spec --noconfirm
      env:
        PYTHONOPTIMIZE: 1
        
    - name: Verify build
      shell: pwsh
      run: |
        $exePath = "dist/${{ env.APP_NAME }}/${{ env.APP_NAME }}.exe"
        if (Test-Path $exePath) {
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ“ Build successful: $exePath"
          Write-Host "âœ“ File size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "âœ— Build failed: executable not found"
          exit 1
        }
        
    - name: Prepare release package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # å¤åˆ¶ README å’Œé…ç½®æ–‡ä»¶
        Copy-Item README.md dist/${{ env.APP_NAME }}/ -ErrorAction SilentlyContinue
        Copy-Item README_ä¸­æ–‡.md dist/${{ env.APP_NAME }}/ -ErrorAction SilentlyContinue
        
        # ç¡®ä¿æ•°æ®ç›®å½•ç»“æ„å­˜åœ¨
        New-Item -ItemType Directory -Force -Path dist/${{ env.APP_NAME }}/data/databases | Out-Null
        New-Item -ItemType Directory -Force -Path dist/${{ env.APP_NAME }}/temp | Out-Null
        New-Item -ItemType Directory -Force -Path dist/${{ env.APP_NAME }}/output | Out-Null
        New-Item -ItemType Directory -Force -Path dist/${{ env.APP_NAME }}/logs | Out-Null
        
        # åˆ›å»º .gitkeep æ–‡ä»¶
        New-Item -ItemType File -Force -Path dist/${{ env.APP_NAME }}/data/databases/.gitkeep | Out-Null
        
    - name: Create ZIP archive
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $zipName = "${{ env.APP_NAME }}_v${version}_Windows_x64.zip"
        Compress-Archive -Path dist/${{ env.APP_NAME }}/* -DestinationPath $zipName -Force
        
        # æ˜¾ç¤ºåŒ…ä¿¡æ¯
        $zipSize = (Get-Item $zipName).Length / 1MB
        Write-Host "âœ“ Package: $zipName"
        Write-Host "âœ“ Size: $([math]::Round($zipSize, 2)) MB"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}_v${{ steps.version.outputs.VERSION }}_Windows_x64
        path: ${{ env.APP_NAME }}_v${{ steps.version.outputs.VERSION }}_Windows_x64.zip
        retention-days: 30

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    # ä»…åœ¨æ¨é€æ ‡ç­¾æˆ–æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©åˆ›å»ºå‘å¸ƒæ—¶è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        elif [[ -n "${{ github.event.inputs.version }}" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        pattern: ${{ env.APP_NAME }}_*
        merge-multiple: true
        
    - name: List release files
      run: |
        echo "Release files:"
        ls -la *.zip || echo "No zip files found"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: FSMatbinBD v${{ steps.version.outputs.VERSION }}
        tag_name: v${{ steps.version.outputs.VERSION }}
        body: |
          ## FSMatbinBD v${{ steps.version.outputs.VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|------|
          | Windows x64 | `FSMatbinBD_v${{ steps.version.outputs.VERSION }}_Windows_x64.zip` | 64ä½ Windows ç³»ç»Ÿ |
          
          ### ğŸš€ å®‰è£…è¯´æ˜
          
          1. ä¸‹è½½ä¸Šæ–¹å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `FSMatbinBD.exe`
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          - é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®ç›®å½• (`data/databases/`)
          - å¦‚éœ€ä½¿ç”¨ DCX å¯¼å…¥åŠŸèƒ½ï¼Œè¯·ç¡®ä¿ `tools/WitchyBND/` ç›®å½•å®Œæ•´
          - æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç•Œé¢ï¼Œå¯åœ¨è®¾ç½®ä¸­åˆ‡æ¢
          
          ### ğŸ“ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10/11 (64ä½)
          - æ— éœ€å®‰è£… Python æˆ–å…¶ä»–ä¾èµ–
          
          ### ğŸ”„ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹ [æ›´æ–°æ—¥å¿—](CHANGELOG.md) è·å–è¯¦ç»†ä¿¡æ¯ã€‚
          
        files: |
          *.zip
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
