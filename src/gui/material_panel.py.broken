#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æè´¨ä¿¡æ¯é¢æ¿
"""

impor        ttk.Button(button_frame, text="ğŸ’¾ å¦å­˜ä¸º", 
                  command=self._export_material).pack(side=tk.LEFT)
        
        # åˆ†éš”çº¿
        self.separator = ttk.Separator(self.scrollable_frame, orient='horizontal')
        
        # åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
        self._create_basic_info_section()nter as tk
from tkinter import ttk, messagebox
import json
from typing import Dict, Any, Callable, Optional, List
from src.gui.theme import ModernDarkTheme

class MaterialPanel:
    """æè´¨ä¿¡æ¯ç¼–è¾‘é¢æ¿"""
    
    def __init__(self, parent, 
                 on_material_save: Callable[[Dict[str, Any]], None] = None,
                 on_material_export: Callable[[], None] = None):
        """
        åˆå§‹åŒ–æè´¨ä¿¡æ¯é¢æ¿
        
        Args:
            parent: çˆ¶å®¹å™¨
            on_material_save: æè´¨ä¿å­˜å›è°ƒ
            on_material_export: æè´¨å¯¼å‡ºå›è°ƒ
        """
        self.parent = parent
        self.on_material_save = on_material_save
        self.on_material_export = on_material_export
        
        self.current_material = None
        self.param_widgets = {}
        
        self._create_widgets()
        self._setup_bindings()
    
    def _create_widgets(self):
        """åˆ›å»ºç•Œé¢ç»„ä»¶"""
        # ä¸»å®¹å™¨
        main_frame = ttk.Frame(self.parent)
        main_frame.pack(fill=tk.BOTH, expand=True)
        
        # åˆ›å»ºCanvaså’ŒScrollbarç”¨äºæ»šåŠ¨
        canvas = tk.Canvas(main_frame, bg='white')
        scrollbar = ttk.Scrollbar(main_frame, orient=tk.VERTICAL, command=canvas.yview)
        self.scrollable_frame = ttk.Frame(canvas)
        
        self.scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # ç»‘å®šé¼ æ ‡æ»šè½®äº‹ä»¶
        def _on_mousewheel(event):
            canvas.yview_scroll(int(-1*(event.delta/120)), "units")
        canvas.bind_all("<MouseWheel>", _on_mousewheel)
        
        # æ ‡é¢˜
        self.title_frame = ttk.Frame(self.scrollable_frame)
        self.title_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(self.title_frame, text="æè´¨ä¿¡æ¯", 
                 style='Title.TLabel').pack(side=tk.LEFT)
        
        # æ“ä½œæŒ‰é’®
        button_frame = ttk.Frame(self.title_frame)
        button_frame.pack(side=tk.RIGHT)
        
        ttk.Button(button_frame, text="ï¿½ å¦å­˜ä¸º", 
                  command=self._export_material).pack(side=tk.LEFT)
        
        # åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
        self._create_basic_info_section()
        
        # å‚æ•°åŒºåŸŸ
        self._create_params_section()
        
        # åˆå§‹çŠ¶æ€æ˜¾ç¤ºæç¤º
        self.empty_label = ttk.Label(self.scrollable_frame, 
                                   text="è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæè´¨æ¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯",
                                   style='Info.TLabel')
        self.empty_label.pack(expand=True, pady=50)
        
        # è®¾ç½® content_frame å¼•ç”¨ï¼ˆä¸ºäº†å…¼å®¹æ€§ï¼‰
        self.content_frame = self.scrollable_frame
    
    def _create_basic_info_section(self):
        """åˆ›å»ºåŸºæœ¬ä¿¡æ¯åŒºåŸŸ - ä¸€è¡Œä¸¤ä¸ªä¿¡æ¯"""
        self.basic_frame = ttk.LabelFrame(self.scrollable_frame, text="åŸºæœ¬ä¿¡æ¯")
        self.basic_frame.pack(fill=tk.X, pady=(10, 10))
        
        # åˆ›å»ºåŸºæœ¬ä¿¡æ¯å­—æ®µ
        self.basic_vars = {}
        basic_fields = [
            ('filename', 'æè´¨åç§°'),
            ('shader_path', 'ç€è‰²å™¨è·¯å¾„'),
            ('source_path', 'æè´¨æ–‡ä»¶è·¯å¾„'),
            ('compression', 'å‹ç¼©ç±»å‹'),
            ('key', 'é”®å€¼')
        ]
        
        # ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ï¼Œæ¯è¡Œä¸¤ä¸ªå­—æ®µ
        info_container = ttk.Frame(self.basic_frame)
        info_container.pack(fill=tk.X, padx=10, pady=10)
        
        row = 0
        col = 0
        
        for field, label in basic_fields:
            # åˆ›å»ºå­—æ®µå®¹å™¨
            field_frame = ttk.Frame(info_container)
            field_frame.grid(row=row, column=col, sticky='ew', 
                           padx=(0, 15 if col == 0 else 0), pady=3)
            
            # æ ‡ç­¾
            label_widget = ttk.Label(field_frame, text=f"{label}:", 
                                   font=('Microsoft YaHei UI', 9),
                                   width=12, anchor='w')
            label_widget.pack(side=tk.LEFT)
            
            # è¾“å…¥æ¡†
            var = tk.StringVar()
            self.basic_vars[field] = var
            
            entry = ttk.Entry(field_frame, textvariable=var, 
                            font=('Microsoft YaHei UI', 9), width=25)
            entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))
            
            # å¸ƒå±€æ§åˆ¶
            col += 1
            if col >= 2:  # æ¯è¡Œä¸¤ä¸ª
                col = 0
                row += 1
        
        # é…ç½®åˆ—æƒé‡
        info_container.grid_columnconfigure(0, weight=1)
        info_container.grid_columnconfigure(1, weight=1)
    
    def _create_params_section(self):
        """åˆ›å»ºå‚æ•°åŒºåŸŸ"""
        self.params_frame = ttk.LabelFrame(self.scrollable_frame, text="å¯ç¼–è¾‘å‚æ•°")
        
        # å‚æ•°å·¥å…·æ 
        param_toolbar = ttk.Frame(self.params_frame)
        param_toolbar.pack(fill=tk.X, padx=10, pady=5)
        
        ttk.Button(param_toolbar, text="â• æ·»åŠ å‚æ•°", 
                  command=self._add_param).pack(side=tk.LEFT)
        ttk.Button(param_toolbar, text="ğŸ”„ åˆ·æ–°", 
                  command=self._refresh_params).pack(side=tk.LEFT, padx=(10, 0))
        
        # å‚æ•°ç½‘æ ¼å®¹å™¨ - æ”¯æŒè‡ªé€‚åº”å¸ƒå±€
        self.params_grid_frame = ttk.Frame(self.params_frame)
        self.params_grid_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
        
        # ç»‘å®šå¤§å°å˜åŒ–äº‹ä»¶
        self.params_grid_frame.bind('<Configure>', self._on_params_frame_configure)
    
    def _on_params_frame_configure(self, event):
        """å‚æ•°æ¡†æ¶å¤§å°å˜åŒ–äº‹ä»¶"""
        # é‡æ–°å¸ƒå±€å‚æ•°æ§ä»¶
        self._layout_params_grid()
    
    def _layout_params_grid(self):
        """ä½¿ç”¨ç½‘æ ¼å¸ƒå±€å‚æ•°æ§ä»¶"""
        if not hasattr(self, 'param_widgets') or not self.param_widgets:
            return
        
        # è·å–æ¡†æ¶å®½åº¦
        frame_width = self.params_grid_frame.winfo_width()
        if frame_width <= 1:  # æ¡†æ¶è¿˜æ²¡æœ‰æ­£ç¡®å¤§å°
            return
        
        # è®¡ç®—æ¯ä¸ªå‚æ•°æ§ä»¶çš„æœ€å°å®½åº¦ï¼ˆä¼°è®¡å€¼ï¼‰
        min_param_width = 350
        
        # è®¡ç®—åˆ—æ•°
        columns = max(1, frame_width // min_param_width)
        
        # é‡æ–°æ’åˆ—å‚æ•°æ§ä»¶
        row = 0
        col = 0
        
        for index, widget_data in self.param_widgets.items():
            frame = widget_data.get('frame')
            if frame and frame.winfo_exists():
                frame.grid(row=row, column=col, sticky='ew', padx=5, pady=5)
                
                col += 1
                if col >= columns:
                    col = 0
                    row += 1
        
        # é…ç½®åˆ—æƒé‡
        for c in range(columns):
            self.params_grid_frame.grid_columnconfigure(c, weight=1)
    
    def _setup_bindings(self):
        """è®¾ç½®äº‹ä»¶ç»‘å®š"""
        # ç›®å‰æ²¡æœ‰ç‰¹æ®Šçš„äº‹ä»¶ç»‘å®šéœ€æ±‚
        # å¦‚æœå°†æ¥éœ€è¦å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
        pass
    
    def load_material(self, material_data: Dict[str, Any]):
        """åŠ è½½æè´¨æ•°æ®"""
        self.current_material = material_data
        
        # éšè—ç©ºçŠ¶æ€æç¤º
        self.empty_label.pack_forget()
        
        # æ˜¾ç¤ºæ ‡é¢˜å’Œå†…å®¹åŒºåŸŸ
        self.title_frame.pack(fill=tk.X, padx=10, pady=(10, 0))
        self.separator.pack(fill=tk.X, padx=10, pady=5)
        self.content_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
        
        # æ˜¾ç¤ºä¿¡æ¯åŒºåŸŸ
        self.basic_frame.pack(fill=tk.X, pady=(10, 10))
        self.params_frame.pack(fill=tk.BOTH, expand=True)
        
        # åŠ è½½åŸºæœ¬ä¿¡æ¯
        self._load_basic_info()
        
        # åŠ è½½å‚æ•°
        self._load_params()
    
    def _load_basic_info(self):
        """åŠ è½½åŸºæœ¬ä¿¡æ¯"""
        if not self.current_material:
            return
        
        # è®¾ç½®åŸºæœ¬ä¿¡æ¯å­—æ®µ
        for field, var in self.basic_vars.items():
            value = self.current_material.get(field, '')
            if field == 'key':
                value = self.current_material.get('key_value', '')
            var.set(str(value))
    
    def _load_params(self):
        """åŠ è½½å‚æ•°åˆ—è¡¨"""
        # æ¸…ç©ºç°æœ‰å‚æ•°æ§ä»¶
        for widget in self.params_grid_frame.winfo_children():
            widget.destroy()
        self.param_widgets.clear()
        
        if not self.current_material or not self.current_material.get('params'):
            ttk.Label(self.params_grid_frame, text="æ­¤æè´¨æ²¡æœ‰å¯ç¼–è¾‘å‚æ•°", 
                     style='Info.TLabel').grid(row=0, column=0, pady=20)
            return
        
        # åˆ›å»ºå‚æ•°æ§ä»¶
        for i, param in enumerate(self.current_material['params']):
            self._create_param_widget(i, param)
        
        # å¸ƒå±€å‚æ•°
        self.params_grid_frame.after(100, self._layout_params_grid)
    
    def _create_param_widget(self, index: int, param: Dict[str, Any]):
        """åˆ›å»ºå•ä¸ªå‚æ•°æ§ä»¶"""
        # å‚æ•°æ¡†æ¶
        param_frame = ttk.LabelFrame(self.params_grid_frame, 
                                   text=f"å‚æ•°: {param.get('name', 'Unknown')}")
        
        # å‚æ•°ä¿¡æ¯è¡Œ
        info_frame = ttk.Frame(param_frame)
        info_frame.pack(fill=tk.X, padx=5, pady=5)
        
        # å‚æ•°åç§°
        name_frame = ttk.Frame(info_frame)
        name_frame.pack(fill=tk.X, pady=1)
        
        ttk.Label(name_frame, text="åç§°:", width=8).pack(side=tk.LEFT)
        name_var = tk.StringVar(value=param.get('name', ''))
        name_entry = ttk.Entry(name_frame, textvariable=name_var, width=25)
        name_entry.pack(side=tk.LEFT, padx=(2, 0), fill=tk.X, expand=True)
        
        # å‚æ•°ç±»å‹å’Œé”®å€¼åœ¨ä¸€è¡Œ
        type_key_frame = ttk.Frame(info_frame)
        type_key_frame.pack(fill=tk.X, pady=1)
        
        ttk.Label(type_key_frame, text="ç±»å‹:", width=8).pack(side=tk.LEFT)
        type_var = tk.StringVar(value=param.get('type', ''))
        type_combo = ttk.Combobox(type_key_frame, textvariable=type_var, width=10,
                                values=['Bool', 'Int', 'Float', 'String', 'Int2', 'Float2', 
                                       'Float3', 'Float4', 'Float5'])
        type_combo.pack(side=tk.LEFT, padx=(2, 5))
        
        ttk.Label(type_key_frame, text="é”®:", width=4).pack(side=tk.LEFT)
        key_var = tk.StringVar(value=param.get('key_value', ''))
        key_entry = ttk.Entry(type_key_frame, textvariable=key_var, width=10)
        key_entry.pack(side=tk.LEFT, padx=(2, 0))
        
        # å‚æ•°å€¼å’Œåˆ é™¤æŒ‰é’®
        value_frame = ttk.Frame(info_frame)
        value_frame.pack(fill=tk.X, pady=1)
        
        ttk.Label(value_frame, text="å€¼:", width=8).pack(side=tk.LEFT)
        
        # æ ¹æ®å‚æ•°ç±»å‹åˆ›å»ºä¸åŒçš„è¾“å…¥æ§ä»¶
        value_widget = self._create_value_widget(value_frame, param)
        
        # åˆ é™¤æŒ‰é’®
        ttk.Button(value_frame, text="ğŸ—‘ï¸", width=3,
                  command=lambda idx=index: self._delete_param(idx)).pack(side=tk.RIGHT, padx=(5, 0))
        
        # å­˜å‚¨æ§ä»¶å¼•ç”¨
        self.param_widgets[index] = {
            'frame': param_frame,
            'name': name_var,
            'type': type_var,
            'key': key_var,
            'value': value_widget,
            'original': param
        }
    
    def _create_value_widget(self, parent, param: Dict[str, Any]):
        """æ ¹æ®å‚æ•°ç±»å‹åˆ›å»ºå€¼è¾“å…¥æ§ä»¶"""
        param_type = param.get('type', '').lower()
        param_value = param.get('value')
        
        if param_type == 'bool':
            # å¸ƒå°”å€¼ä½¿ç”¨å¤é€‰æ¡†
            var = tk.BooleanVar(value=bool(param_value) if param_value is not None else False)
            widget = ttk.Checkbutton(parent, variable=var, text="å¯ç”¨")
            widget.pack(side=tk.LEFT, padx=(5, 0))
            return var
            
        elif param_type in ['int2', 'float2', 'float3', 'float4', 'float5']:
            # æ•°ç»„ç±»å‹ä½¿ç”¨å¤šä¸ªè¾“å…¥æ¡†
            array_frame = ttk.Frame(parent)
            array_frame.pack(side=tk.LEFT, padx=(5, 0), fill=tk.X, expand=True)
            
            # ç¡®å®šæ•°ç»„é•¿åº¦
            array_length = int(param_type[-1])
            array_vars = []
            
            # ç¡®ä¿param_valueæ˜¯åˆ—è¡¨
            if not isinstance(param_value, list):
                param_value = [0] * array_length
            elif len(param_value) < array_length:
                param_value.extend([0] * (array_length - len(param_value)))
            
            for i in range(array_length):
                var = tk.StringVar(value=str(param_value[i] if i < len(param_value) else 0))
                entry = ttk.Entry(array_frame, textvariable=var, width=10)
                entry.pack(side=tk.LEFT, padx=(0, 5))
                array_vars.append(var)
            
            return array_vars
            
        else:
            # é»˜è®¤ä½¿ç”¨æ–‡æœ¬è¾“å…¥æ¡†
            var = tk.StringVar(value=str(param_value) if param_value is not None else '')
            entry = ttk.Entry(parent, textvariable=var, width=40)
            entry.pack(side=tk.LEFT, padx=(5, 0), fill=tk.X, expand=True)
            return var
    
    def _add_param(self):
        """æ·»åŠ æ–°å‚æ•°"""
        # åˆ›å»ºæ–°å‚æ•°å¯¹è¯æ¡†
        dialog = ParameterDialog(self.parent, "æ·»åŠ å‚æ•°")
        if dialog.result:
            name, param_type, key_value, value = dialog.result
            
            # åˆ›å»ºæ–°å‚æ•°æ•°æ®
            new_param = {
                'name': name,
                'type': param_type,
                'key_value': key_value,
                'value': value
            }
            
            # æ·»åŠ åˆ°å½“å‰æè´¨
            if not self.current_material:
                self.current_material = {'params': []}
            elif 'params' not in self.current_material:
                self.current_material['params'] = []
            
            self.current_material['params'].append(new_param)
            
            # åˆ·æ–°å‚æ•°æ˜¾ç¤º
            self._load_params()
    
    def _delete_param(self, index: int):
        """åˆ é™¤å‚æ•°"""
        if index in self.param_widgets:
            if messagebox.askyesno("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‚æ•°å—ï¼Ÿ"):
                # ä»ç•Œé¢ç§»é™¤
                self.param_widgets[index]['frame'].destroy()
                del self.param_widgets[index]
                
                # ä»æ•°æ®ä¸­ç§»é™¤
                if (self.current_material and 
                    'params' in self.current_material and 
                    index < len(self.current_material['params'])):
                    del self.current_material['params'][index]
                
                # é‡æ–°åŠ è½½å‚æ•°ï¼ˆé‡æ–°ç¼–å·ï¼‰
                self._load_params()
    
    def _refresh_params(self):
        """åˆ·æ–°å‚æ•°æ˜¾ç¤º"""
        self._load_params()
    
    def _save_as_material(self):
        """å¦å­˜ä¸ºæè´¨"""
        if not self.current_material:
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰å¯ä¿å­˜çš„æè´¨")
            return
        
        # ç›´æ¥è°ƒç”¨å¯¼å‡ºåŠŸèƒ½ï¼ˆå¦å­˜ä¸ºå°±æ˜¯å¯¼å‡ºï¼‰
        if self.on_material_export:
            self.on_material_export()
    
    def _save_material(self):
        """ä¿å­˜æè´¨ï¼ˆå·²ç§»é™¤ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰"""
        # é‡å®šå‘åˆ°å¦å­˜ä¸º
        self._save_as_material()
    
    def _export_material(self):
        """å¯¼å‡ºæè´¨ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰"""
        # é‡å®šå‘åˆ°å¦å­˜ä¸º
        self._save_as_material()
    
    def get_material_data(self) -> Dict[str, Any]:
        """è·å–å½“å‰ç¼–è¾‘çš„æè´¨æ•°æ®"""
        if not self.current_material:
            return {}
        
        # å¤åˆ¶åŸºæœ¬æ•°æ®
        material_data = self.current_material.copy()
        
        # æ›´æ–°åŸºæœ¬ä¿¡æ¯
        for field, var in self.basic_vars.items():
            if field == 'key':
                material_data['key'] = var.get()
            else:
                material_data[field] = var.get()
        
        # æ›´æ–°å‚æ•°
        params = []
        for index, widget_data in self.param_widgets.items():
            param = {
                'name': widget_data['name'].get(),
                'type': widget_data['type'].get(),
                'key_value': widget_data['key'].get(),
                'value': self._get_param_value(widget_data)
            }
            params.append(param)
        
        material_data['params'] = params
        
        return material_data
    
    def _get_param_value(self, widget_data: Dict[str, Any]):
        """è·å–å‚æ•°å€¼"""
        param_type = widget_data['type'].get().lower()
        value_widget = widget_data['value']
        
        if param_type == 'bool':
            return value_widget.get()
        elif param_type in ['int2', 'float2', 'float3', 'float4', 'float5']:
            # æ•°ç»„ç±»å‹
            values = []
            for var in value_widget:
                try:
                    if param_type.startswith('int'):
                        values.append(int(var.get()))
                    else:
                        values.append(float(var.get()))
                except ValueError:
                    values.append(0)
            return values
        elif param_type == 'int':
            try:
                return int(value_widget.get())
            except ValueError:
                return 0
        elif param_type == 'float':
            try:
                return float(value_widget.get())
            except ValueError:
                return 0.0
        else:
            return value_widget.get()
    
    def clear(self):
        """æ¸…ç©ºé¢æ¿"""
        self.current_material = None
        
        # éšè—æ ‡é¢˜å’Œå†…å®¹åŒºåŸŸ
        self.title_frame.pack_forget()
        self.separator.pack_forget()
        self.content_frame.pack_forget()
        
        # éšè—ä¿¡æ¯åŒºåŸŸ
        self.basic_frame.pack_forget()
        self.params_frame.pack_forget()
        
        # æ˜¾ç¤ºç©ºçŠ¶æ€
        self.empty_label.pack(expand=True)
        
        # æ¸…ç©ºåŸºæœ¬ä¿¡æ¯
        for var in self.basic_vars.values():
            var.set("")
        
        # æ¸…ç©ºå‚æ•°
        for widget in self.params_grid_frame.winfo_children():
            widget.destroy()
        self.param_widgets.clear()


class ParameterDialog:
    """å‚æ•°æ·»åŠ /ç¼–è¾‘å¯¹è¯æ¡†"""
    
    def __init__(self, parent, title: str = "å‚æ•°è®¾ç½®", param_data: Dict[str, Any] = None):
        self.result = None
        
        # åˆ›å»ºå¯¹è¯æ¡†
        self.dialog = tk.Toplevel(parent)
        self.dialog.title(title)
        self.dialog.geometry("500x300")
        self.dialog.transient(parent)
        self.dialog.grab_set()
        
        # å±…ä¸­æ˜¾ç¤º
        self.dialog.geometry("+%d+%d" % (parent.winfo_rootx() + 100, parent.winfo_rooty() + 100))
        
        # åˆ›å»ºç•Œé¢
        self._create_widgets(param_data)
        
        # ç­‰å¾…ç”¨æˆ·æ“ä½œ
        self.dialog.wait_window()
    
    def _create_widgets(self, param_data: Dict[str, Any] = None):
        """åˆ›å»ºå¯¹è¯æ¡†ç•Œé¢"""
        main_frame = ttk.Frame(self.dialog)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # å‚æ•°åç§°
        ttk.Label(main_frame, text="å‚æ•°åç§°:").pack(anchor=tk.W, pady=(0, 5))
        self.name_var = tk.StringVar(value=param_data.get('name', '') if param_data else '')
        name_entry = ttk.Entry(main_frame, textvariable=self.name_var, width=50)
        name_entry.pack(fill=tk.X, pady=(0, 10))
        
        # å‚æ•°ç±»å‹
        ttk.Label(main_frame, text="å‚æ•°ç±»å‹:").pack(anchor=tk.W, pady=(0, 5))
        self.type_var = tk.StringVar(value=param_data.get('type', 'String') if param_data else 'String')
        type_combo = ttk.Combobox(main_frame, textvariable=self.type_var, width=20,
                                values=['Bool', 'Int', 'Float', 'String', 'Int2', 'Float2', 
                                       'Float3', 'Float4', 'Float5'])
        type_combo.pack(anchor=tk.W, pady=(0, 10))
        
        # é”®å€¼
        ttk.Label(main_frame, text="é”®å€¼:").pack(anchor=tk.W, pady=(0, 5))
        self.key_var = tk.StringVar(value=param_data.get('key_value', '') if param_data else '')
        key_entry = ttk.Entry(main_frame, textvariable=self.key_var, width=50)
        key_entry.pack(fill=tk.X, pady=(0, 10))
        
        # å‚æ•°å€¼
        ttk.Label(main_frame, text="å‚æ•°å€¼:").pack(anchor=tk.W, pady=(0, 5))
        self.value_var = tk.StringVar(value=str(param_data.get('value', '')) if param_data else '')
        value_entry = ttk.Entry(main_frame, textvariable=self.value_var, width=50)
        value_entry.pack(fill=tk.X, pady=(0, 20))
        
        # æŒ‰é’®
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill=tk.X)
        
        ttk.Button(button_frame, text="ç¡®å®š", command=self._on_ok).pack(side=tk.RIGHT, padx=(10, 0))
        ttk.Button(button_frame, text="å–æ¶ˆ", command=self._on_cancel).pack(side=tk.RIGHT)
        
        # ç»‘å®šå›è½¦é”®
        self.dialog.bind('<Return>', lambda e: self._on_ok())
        self.dialog.bind('<Escape>', lambda e: self._on_cancel())
        
        # ç„¦ç‚¹
        name_entry.focus()
    
    def _on_ok(self):
        name = self.name_var.get().strip()
        if not name:
            messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥å‚æ•°åç§°")
            return
        
        param_type = self.type_var.get()
        key_value = self.key_var.get().strip()
        value_str = self.value_var.get().strip()
        
        # è§£æå€¼
        try:
            if param_type.lower() == 'bool':
                value = value_str.lower() in ['true', '1', 'yes', 'on']
            elif param_type.lower() == 'int':
                value = int(value_str) if value_str else 0
            elif param_type.lower() == 'float':
                value = float(value_str) if value_str else 0.0
            elif param_type.lower() in ['int2', 'float2', 'float3', 'float4', 'float5']:
                # è§£ææ•°ç»„
                if value_str:
                    parts = value_str.split(',')
                    if param_type.lower().startswith('int'):
                        value = [int(p.strip()) for p in parts]
                    else:
                        value = [float(p.strip()) for p in parts]
                else:
                    array_length = int(param_type[-1])
                    value = [0] * array_length
            else:
                value = value_str
        except ValueError as e:
            messagebox.showerror("é”™è¯¯", f"å‚æ•°å€¼æ ¼å¼é”™è¯¯ï¼š{str(e)}")
            return
        
        self.result = (name, param_type, key_value, value)
        self.dialog.destroy()
    
    def _on_cancel(self):
        self.dialog.destroy()