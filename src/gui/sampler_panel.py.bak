#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æè´¨æ ·ä¾‹é¢æ¿ - æ˜¾ç¤ºæè´¨çš„Samplerä¿¡æ¯ï¼ˆåªè¯»ï¼Œæ”¯æŒå¤åˆ¶ï¼‰
"""

import tkinter as tk
from tkinter import ttk, messagebox
import os
from typing import List, Dict, Any
from src.gui.theme import ModernDarkTheme

class SamplerPanel:
    """æè´¨æ ·ä¾‹é¢æ¿ï¼ˆåªè¯»ç‰ˆæœ¬ï¼‰"""
    
    def __init__(self, parent):
        """
        åˆå§‹åŒ–æ ·ä¾‹é¢æ¿
        
        Args:
            parent: çˆ¶å®¹å™¨
        """
        self.parent = parent
        self.samplers_data = []
        
        self._create_widgets()
    
    def _create_widgets(self):
        """åˆ›å»ºç•Œé¢ç»„ä»¶"""
        # ä¸»æ¡†æ¶
        main_frame = ttk.Frame(self.parent)
        main_frame.pack(fill=tk.BOTH, expand=True)
        
        # å›ºå®šæ ‡é¢˜æ ï¼ˆä¸æ»šåŠ¨ï¼‰
        title_frame = ttk.Frame(main_frame)
        title_frame.pack(fill=tk.X, padx=10, pady=(10, 5))
        
        ttk.Label(title_frame, text="æè´¨æ ·ä¾‹ (Samplers)", 
                 style='Heading.TLabel').pack(side=tk.LEFT)
        
        # ç»Ÿè®¡ä¿¡æ¯
        self.count_label = ttk.Label(title_frame, text="", style='Info.TLabel')
        self.count_label.pack(side=tk.RIGHT)
        
        # æç¤ºä¿¡æ¯
        hint_frame = ttk.Frame(main_frame)
        hint_frame.pack(fill=tk.X, padx=10, pady=(0, 5))
        
        ttk.Label(hint_frame, text="ğŸ’¡ åŒå‡»ä»»æ„åˆ—å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿", 
                 style='Info.TLabel').pack(side=tk.LEFT)
        
        # æ ·ä¾‹åˆ—è¡¨å®¹å™¨
        list_frame = ttk.Frame(main_frame)
        list_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
        
        # é…ç½®TreeView - ç®€åŒ–åˆ—ç»“æ„
        columns = ('type', 'path')
        self.sampler_tree = ttk.Treeview(list_frame, columns=columns, 
                                       show='tree headings', height=8)
        
        # é…ç½®åˆ—æ ‡é¢˜å’Œå®½åº¦
        self.sampler_tree.heading('#0', text='åºå·')
        self.sampler_tree.heading('type', text='é‡‡æ ·å™¨ç±»å‹')
        self.sampler_tree.heading('path', text='é‡‡æ ·å™¨è·¯å¾„')
        
        self.sampler_tree.column('#0', width=60, minwidth=60, anchor='center')
        self.sampler_tree.column('type', width=200, minwidth=150)
        self.sampler_tree.column('path', width=400, minwidth=200)
        
        # æ»šåŠ¨æ¡
        scrollbar_v = ttk.Scrollbar(list_frame, orient=tk.VERTICAL,
                                  command=self.sampler_tree.yview)
        scrollbar_h = ttk.Scrollbar(list_frame, orient=tk.HORIZONTAL,
                                  command=self.sampler_tree.xview)
        
        self.sampler_tree.configure(yscrollcommand=scrollbar_v.set,
                                  xscrollcommand=scrollbar_h.set)
        
        # å¸ƒå±€
        self.sampler_tree.grid(row=0, column=0, sticky='nsew')
        scrollbar_v.grid(row=0, column=1, sticky='ns')
        scrollbar_h.grid(row=1, column=0, sticky='ew')
        
        list_frame.grid_rowconfigure(0, weight=1)
        list_frame.grid_columnconfigure(0, weight=1)
        
        # ç»‘å®šåŒå‡»äº‹ä»¶
        self.sampler_tree.bind('<Double-1>', self._on_double_click)
        
        # ç©ºçŠ¶æ€æç¤º
        self.empty_label = ttk.Label(main_frame, 
                                   text="è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªæè´¨æ¥æŸ¥çœ‹é‡‡æ ·å™¨ä¿¡æ¯",
                                   style='Info.TLabel')
        self.empty_label.pack(expand=True, pady=20)
        
    def _on_double_click(self, event):
        """åŒå‡»äº‹ä»¶ - å¤åˆ¶å•å…ƒæ ¼å†…å®¹åˆ°å‰ªè´´æ¿"""
        region = self.sampler_tree.identify("region", event.x, event.y)
        if region != "cell":
            return
        
        # è·å–ç‚¹å‡»çš„é¡¹ç›®å’Œåˆ—
        item = self.sampler_tree.identify_row(event.y)
        column = self.sampler_tree.identify_column(event.x)
        
        if not item:
            return
        
        # è·å–å•å…ƒæ ¼å†…å®¹
        if column == "#0":
            # åºå·åˆ—
            cell_value = self.sampler_tree.item(item, "text")
        else:
            # æ•°æ®åˆ—
            column_index = int(column[1:]) - 1  # #1, #2 -> 0, 1
            values = self.sampler_tree.item(item, "values")
            if 0 <= column_index < len(values):
                cell_value = values[column_index]
            else:
                return
        
        # å¤åˆ¶åˆ°å‰ªè´´æ¿
        if cell_value:
            try:
                self.parent.clipboard_clear()
                self.parent.clipboard_append(str(cell_value))
                self._show_copy_feedback(cell_value)
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"å¤åˆ¶å¤±è´¥: {str(e)}")
    
    def _show_copy_feedback(self, content):
        """æ˜¾ç¤ºå¤åˆ¶åé¦ˆ"""
        # é™åˆ¶æ˜¾ç¤ºé•¿åº¦
        display_content = content[:50] + "..." if len(content) > 50 else content
        messagebox.showinfo("å¤åˆ¶æˆåŠŸ", f"å·²å¤åˆ¶åˆ°å‰ªè´´æ¿:\n{display_content}")
    
    def load_samplers(self, samplers: List[Dict[str, Any]]):
        """åŠ è½½æ ·ä¾‹æ•°æ®"""
        self.samplers_data = samplers
        
        if not samplers:
            # æ˜¾ç¤ºç©ºçŠ¶æ€
            self._show_empty_state()
            return
        
        # éšè—ç©ºçŠ¶æ€
        self.empty_label.pack_forget()
        
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.sampler_tree.get_children():
            self.sampler_tree.delete(item)
        
        # æ·»åŠ æ ·ä¾‹æ•°æ®
        for i, sampler in enumerate(samplers):
            # å¤„ç†è·¯å¾„æ˜¾ç¤º
            path = sampler.get('path', '')
            sampler_type = sampler.get('type', '')
            
            # æ’å…¥æ•°æ®
            self.sampler_tree.insert('', tk.END,
                                   text=str(i + 1),
                                   values=(sampler_type, path))
        
        # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        self.count_label.config(text=f"å…± {len(samplers)} ä¸ªé‡‡æ ·å™¨")
    
    def _show_empty_state(self):
        """æ˜¾ç¤ºç©ºçŠ¶æ€"""
        self.empty_label.pack(expand=True, pady=20)
        
        # æ¸…ç©ºåˆ—è¡¨
        for item in self.sampler_tree.get_children():
            self.sampler_tree.delete(item)
        
        # æ¸…ç©ºç»Ÿè®¡
        self.count_label.config(text="")
    
    def clear(self):
        """æ¸…ç©ºé¢æ¿"""
        self.samplers_data = []
        self._show_empty_state()
    
    def _create_detail_panel(self, parent):
        """åˆ›å»ºè¯¦ç»†ä¿¡æ¯é¢æ¿"""
        self.detail_frame = ttk.LabelFrame(parent, text="æ ·ä¾‹è¯¦ç»†ä¿¡æ¯")
        
        # è¯¦ç»†ä¿¡æ¯å†…å®¹
        detail_content = ttk.Frame(self.detail_frame)
        detail_content.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # åˆ›å»ºè¯¦ç»†ä¿¡æ¯å­—æ®µ
        self.detail_vars = {}
        detail_fields = [
            ('type', 'æè´¨ç±»å‹'),
            ('path', 'æè´¨è·¯å¾„'),
            ('key', 'é”®å€¼'),
            ('unk14_x', 'Unk14 X'),
            ('unk14_y', 'Unk14 Y')
        ]
        
        for i, (field, label) in enumerate(detail_fields):
            row_frame = ttk.Frame(detail_content)
            row_frame.pack(fill=tk.X, pady=2)
            
            ttk.Label(row_frame, text=f"{label}:", width=12).pack(side=tk.LEFT)
            
            var = tk.StringVar()
            self.detail_vars[field] = var
            
            if field == 'path':
                # è·¯å¾„å­—æ®µå¯èƒ½å¾ˆé•¿ï¼Œä½¿ç”¨åªè¯»Entry
                entry = ttk.Entry(row_frame, textvariable=var, state='readonly', width=60)
                entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))
                
                # æ·»åŠ å¤åˆ¶æŒ‰é’®
                ttk.Button(row_frame, text="ğŸ“‹", width=3,
                          command=lambda f=field: self._copy_field(f)).pack(side=tk.RIGHT, padx=(5, 0))
            else:
                entry = ttk.Entry(row_frame, textvariable=var, state='readonly', width=40)
                entry.pack(side=tk.LEFT, padx=(5, 0))
        
        # æ“ä½œæŒ‰é’®
        button_frame = ttk.Frame(detail_content)
        button_frame.pack(fill=tk.X, pady=(10, 0))
        
        ttk.Button(button_frame, text="ï¿½ å¤åˆ¶ç±»å‹", 
                  command=lambda: self._copy_field('type')).pack(side=tk.LEFT)
        ttk.Button(button_frame, text="ğŸ“‹ å¤åˆ¶è·¯å¾„", 
                  command=lambda: self._copy_field('path')).pack(side=tk.LEFT, padx=(10, 0))
    
    def _setup_bindings(self):
        """è®¾ç½®äº‹ä»¶ç»‘å®š"""
        # é€‰æ‹©äº‹ä»¶
        self.sampler_tree.bind('<<TreeviewSelect>>', self._on_sampler_select)
        
        # åŒå‡»äº‹ä»¶
        self.sampler_tree.bind('<Double-1>', self._on_sampler_double_click)
        
        # å³é”®èœå•
        self.sampler_tree.bind('<Button-3>', self._show_context_menu)
    
    def load_samplers(self, samplers: List[Dict[str, Any]]):
        """åŠ è½½æ ·ä¾‹æ•°æ®"""
        self.samplers_data = samplers
        
        if not samplers:
            # æ˜¾ç¤ºç©ºçŠ¶æ€
            self._show_empty_state()
            return
        
        # éšè—ç©ºçŠ¶æ€
        self.empty_label.pack_forget()
        
        # æ˜¾ç¤ºåˆ—è¡¨å’Œè¯¦ç»†é¢æ¿
        self.sampler_tree.master.pack(fill=tk.BOTH, expand=True, pady=(0, 10))
        self.detail_frame.pack(fill=tk.X)
        
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.sampler_tree.get_children():
            self.sampler_tree.delete(item)
        
        # æ·»åŠ æ ·ä¾‹æ•°æ®
        for i, sampler in enumerate(samplers):
            # å¤„ç†è·¯å¾„æ˜¾ç¤º
            path = sampler.get('path', '')
            display_path = self._format_path(path)
            
            # æ’å…¥æ•°æ®
            item_id = self.sampler_tree.insert('', tk.END,
                                             text=str(i + 1),
                                             values=(
                                                 sampler.get('type', ''),
                                                 display_path
                                             ))
            
            # ä¸ºç©ºè·¯å¾„çš„é¡¹ç›®è®¾ç½®ä¸åŒé¢œè‰²
            if not path:
                self.sampler_tree.set(item_id, 'path', '(ç©ºè·¯å¾„)')
                # å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¸åŒçš„æ ‡ç­¾æˆ–é¢œè‰²
        
        # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        self.count_label.config(text=f"å…± {len(samplers)} ä¸ªæ ·ä¾‹")
        
        # è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€é¡¹
        if samplers:
            first_item = self.sampler_tree.get_children()[0]
            self.sampler_tree.selection_set(first_item)
            self.sampler_tree.focus(first_item)
            self._on_sampler_select(None)
    
    def _format_path(self, path: str) -> str:
        """æ ¼å¼åŒ–è·¯å¾„æ˜¾ç¤º"""
        if not path:
            return ""
        
        # åªæ˜¾ç¤ºæ–‡ä»¶åå’Œéƒ¨åˆ†è·¯å¾„
        if len(path) > 50:
            parts = path.split('\\')
            if len(parts) > 2:
                return f"...\\{parts[-2]}\\{parts[-1]}"
            else:
                return path[-50:]
        return path
    
    def _show_empty_state(self):
        """æ˜¾ç¤ºç©ºçŠ¶æ€"""
        # éšè—åˆ—è¡¨å’Œè¯¦ç»†é¢æ¿
        self.sampler_tree.master.pack_forget()
        self.detail_frame.pack_forget()
        
        # æ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
        self.empty_label.pack(expand=True, pady=20)
        
        # æ¸…ç©ºç»Ÿè®¡ä¿¡æ¯
        self.count_label.config(text="")
        
        # æ¸…ç©ºè¯¦ç»†ä¿¡æ¯
        for var in self.detail_vars.values():
            var.set("")
    
    def _on_sampler_select(self, event):
        """æ ·ä¾‹é€‰æ‹©äº‹ä»¶å¤„ç†"""
        selection = self.sampler_tree.selection()
        if not selection:
            return
        
        item = selection[0]
        index = int(self.sampler_tree.item(item)['text']) - 1
        
        if 0 <= index < len(self.samplers_data):
            sampler = self.samplers_data[index]
            self._load_sampler_detail(sampler)
    
    def _load_sampler_detail(self, sampler: Dict[str, Any]):
        """åŠ è½½æ ·ä¾‹è¯¦ç»†ä¿¡æ¯"""
        # è®¾ç½®åŸºæœ¬ä¿¡æ¯
        self.detail_vars['type'].set(sampler.get('type', ''))
        self.detail_vars['path'].set(sampler.get('path', ''))
        self.detail_vars['key'].set(sampler.get('key_value', ''))
        
        # è®¾ç½®Unk14ä¿¡æ¯
        unk14 = sampler.get('unk14', {})
        self.detail_vars['unk14_x'].set(str(unk14.get('X', 0)))
        self.detail_vars['unk14_y'].set(str(unk14.get('Y', 0)))
    
    def _on_sampler_double_click(self, event):
        """æ ·ä¾‹åŒå‡»äº‹ä»¶å¤„ç† - å¤åˆ¶é€‰ä¸­çš„å†…å®¹"""
        selection = self.sampler_tree.selection()
        if not selection:
            return
        
        item = selection[0]
        
        # è·å–ç‚¹å‡»çš„åˆ—
        region = self.sampler_tree.identify_region(event.x, event.y)
        if region == "cell":
            column = self.sampler_tree.identify_column(event.x, event.y)
            
            if column == '#1':  # æè´¨ç±»å‹åˆ—
                value = self.sampler_tree.item(item)['values'][0]
                self._copy_to_clipboard(value, "æè´¨ç±»å‹")
            elif column == '#2':  # æè´¨è·¯å¾„åˆ—
                # è·å–å®Œæ•´è·¯å¾„è€Œä¸æ˜¯æ˜¾ç¤ºè·¯å¾„
                index = int(self.sampler_tree.item(item)['text']) - 1
                if 0 <= index < len(self.samplers_data):
                    value = self.samplers_data[index].get('path', '')
                    self._copy_to_clipboard(value, "æè´¨è·¯å¾„")
        else:
            # é»˜è®¤å¤åˆ¶æè´¨ç±»å‹
            value = self.sampler_tree.item(item)['values'][0]
            self._copy_to_clipboard(value, "æè´¨ç±»å‹")
    
    def _copy_to_clipboard(self, text: str, field_name: str):
        """å¤åˆ¶åˆ°å‰ªè´´æ¿"""
        if text:
            self.parent.clipboard_clear()
            self.parent.clipboard_append(text)
            messagebox.showinfo("å¤åˆ¶æˆåŠŸ", f"{field_name}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿:\n{text}")
        else:
            messagebox.showwarning("è­¦å‘Š", f"{field_name}ä¸ºç©º")
    
    def _show_context_menu(self, event):
        """æ˜¾ç¤ºå³é”®èœå•"""
        selection = self.sampler_tree.selection()
        if not selection:
            return
        
        menu = tk.Menu(self.parent, tearoff=0)
        menu.add_command(label="å¤åˆ¶æè´¨ç±»å‹", command=lambda: self._copy_field('type'))
        menu.add_command(label="å¤åˆ¶æè´¨è·¯å¾„", command=lambda: self._copy_field('path'))
        menu.add_separator()
        menu.add_command(label="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯", command=lambda: self._show_detail_dialog())
        
        try:
            menu.tk_popup(event.x_root, event.y_root)
        finally:
            menu.grab_release()
    
    def _copy_field(self, field: str):
        """å¤åˆ¶å­—æ®µå€¼åˆ°å‰ªè´´æ¿"""
        value = self.detail_vars.get(field, tk.StringVar()).get()
        if value:
            self.parent.clipboard_clear()
            self.parent.clipboard_append(value)
            messagebox.showinfo("æˆåŠŸ", f"{field}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
        else:
            messagebox.showwarning("è­¦å‘Š", f"{field}ä¸ºç©º")
    
    def _open_file_location(self):
        """æ‰“å¼€æ–‡ä»¶ä½ç½®"""
        path = self.detail_vars.get('path', tk.StringVar()).get()
        if not path:
            messagebox.showwarning("è­¦å‘Š", "æ–‡ä»¶è·¯å¾„ä¸ºç©º")
            return
        
        # æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨
        if not os.path.exists(path):
            # å°è¯•æ˜¾ç¤ºç›®å½•
            directory = os.path.dirname(path)
            if os.path.exists(directory):
                try:
                    os.startfile(directory)
                    messagebox.showinfo("æç¤º", f"æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå·²æ‰“å¼€æ‰€åœ¨ç›®å½•ï¼š\n{directory}")
                except Exception as e:
                    messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€ç›®å½•ï¼š{str(e)}")
            else:
                messagebox.showerror("é”™è¯¯", f"è·¯å¾„ä¸å­˜åœ¨ï¼š\n{path}")
        else:
            try:
                # åœ¨Windowsä¸Šæ‰“å¼€æ–‡ä»¶ä½ç½®
                os.startfile(os.path.dirname(path))
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€æ–‡ä»¶ä½ç½®ï¼š{str(e)}")
    
    def _show_detail_dialog(self):
        """æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†"""
        selection = self.sampler_tree.selection()
        if not selection:
            return
        
        item = selection[0]
        index = int(self.sampler_tree.item(item)['text']) - 1
        
        if 0 <= index < len(self.samplers_data):
            sampler = self.samplers_data[index]
            SamplerDetailDialog(self.parent, sampler, index + 1)
    
    def clear(self):
        """æ¸…ç©ºé¢æ¿"""
        self.samplers_data = []
        self._show_empty_state()
    
    def refresh(self):
        """åˆ·æ–°æ˜¾ç¤º"""
        if self.samplers_data:
            self.load_samplers(self.samplers_data)


class SamplerDetailDialog:
    """æ ·ä¾‹è¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†"""
    
    def __init__(self, parent, sampler_data: Dict[str, Any], index: int = 1):
        """
        åˆ›å»ºæ ·ä¾‹è¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†
        
        Args:
            parent: çˆ¶çª—å£
            sampler_data: æ ·ä¾‹æ•°æ®
            index: æ ·ä¾‹ç´¢å¼•
        """
        # åˆ›å»ºå¯¹è¯æ¡†
        self.dialog = tk.Toplevel(parent)
        self.dialog.title(f"æ ·ä¾‹è¯¦ç»†ä¿¡æ¯ - {index}")
        self.dialog.geometry("600x400")
        self.dialog.transient(parent)
        self.dialog.grab_set()
        
        # å±…ä¸­æ˜¾ç¤º
        self.dialog.geometry("+%d+%d" % (parent.winfo_rootx() + 50, parent.winfo_rooty() + 50))
        
        self._create_widgets(sampler_data)
    
    def _create_widgets(self, sampler_data: Dict[str, Any]):
        """åˆ›å»ºå¯¹è¯æ¡†ç•Œé¢"""
        main_frame = ttk.Frame(self.dialog)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # æ ‡é¢˜
        ttk.Label(main_frame, text="æ ·ä¾‹è¯¦ç»†ä¿¡æ¯", 
                 style='Title.TLabel').pack(anchor=tk.W, pady=(0, 20))
        
        # ä¿¡æ¯è¡¨æ ¼
        info_frame = ttk.Frame(main_frame)
        info_frame.pack(fill=tk.BOTH, expand=True)
        
        # ä¿¡æ¯åˆ—è¡¨
        info_items = [
            ("æè´¨ç±»å‹", sampler_data.get('type', '')),
            ("æè´¨è·¯å¾„", sampler_data.get('path', '')),
            ("é”®å€¼", sampler_data.get('key_value', '')),
        ]
        
        # æ·»åŠ Unk14ä¿¡æ¯
        unk14 = sampler_data.get('unk14', {})
        info_items.extend([
            ("Unk14 X", str(unk14.get('X', 0))),
            ("Unk14 Y", str(unk14.get('Y', 0)))
        ])
        
        # åˆ›å»ºä¿¡æ¯è¡Œ
        for i, (label, value) in enumerate(info_items):
            row_frame = ttk.Frame(info_frame)
            row_frame.pack(fill=tk.X, pady=5)
            
            # æ ‡ç­¾
            ttk.Label(row_frame, text=f"{label}:", width=15, 
                     font=('å¾®è½¯é›…é»‘', 9, 'bold')).pack(side=tk.LEFT)
            
            # å€¼
            if label == "æè´¨è·¯å¾„" and len(value) > 50:
                # é•¿è·¯å¾„ä½¿ç”¨Textæ§ä»¶
                text_widget = tk.Text(row_frame, height=3, wrap=tk.WORD)
                text_widget.insert(tk.END, value)
                text_widget.config(state=tk.DISABLED)
                text_widget.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(10, 0))
            else:
                # æ™®é€šå€¼ä½¿ç”¨Label
                value_label = ttk.Label(row_frame, text=value, 
                                      relief=tk.SUNKEN, padding=5)
                value_label.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(10, 0))
        
        # æŒ‰é’®åŒºåŸŸ
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill=tk.X, pady=(20, 0))
        
        ttk.Button(button_frame, text="å¤åˆ¶è·¯å¾„", 
                  command=lambda: self._copy_to_clipboard(sampler_data.get('path', ''))).pack(side=tk.LEFT)
        
        ttk.Button(button_frame, text="æ‰“å¼€ä½ç½®", 
                  command=lambda: self._open_location(sampler_data.get('path', ''))).pack(side=tk.LEFT, padx=(10, 0))
        
        ttk.Button(button_frame, text="å…³é—­", 
                  command=self.dialog.destroy).pack(side=tk.RIGHT)
        
        # ç»‘å®šEscapeé”®
        self.dialog.bind('<Escape>', lambda e: self.dialog.destroy())
    
    def _copy_to_clipboard(self, text: str):
        """å¤åˆ¶åˆ°å‰ªè´´æ¿"""
        if text:
            self.dialog.clipboard_clear()
            self.dialog.clipboard_append(text)
            messagebox.showinfo("æˆåŠŸ", "è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
        else:
            messagebox.showwarning("è­¦å‘Š", "è·¯å¾„ä¸ºç©º")
    
    def _open_location(self, path: str):
        """æ‰“å¼€æ–‡ä»¶ä½ç½®"""
        if not path:
            messagebox.showwarning("è­¦å‘Š", "è·¯å¾„ä¸ºç©º")
            return
        
        directory = os.path.dirname(path)
        if os.path.exists(directory):
            try:
                os.startfile(directory)
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€ç›®å½•ï¼š{str(e)}")
        else:
            messagebox.showerror("é”™è¯¯", f"ç›®å½•ä¸å­˜åœ¨ï¼š\n{directory}")